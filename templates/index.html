<!DOCTYPE html>
<html>
<head>
    <title>Motor Control</title>
    <style>
        #joystick {
            border: 2px solid black;
            border-radius: 50%;
            width: 200px;
            height: 200px;
            position: relative;
        }
        #knob {
            background-color: gray;
            border: 2px solid black;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            position: absolute;
            top: 75px;
            left: 75px;
            cursor: pointer;
        }
        #stopButton {
            margin-top: 20px;
            background-color: red;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
        }
        .Title{
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="Title">
        <h1>Motor Control</h1>
    </div>
    
    <div>
        <label for="speed">Speed Multiplier (0-255):</label>
        <input type="range" id="speed" name="speed" min="0" max="255" value="127">
    </div>
    <div id="stopButton">
        <button onclick="controlMotors(0, 0)">Emergency Stop</button>
    </div>
    <div id="joystick">
        <div id="knob"></div>
    </div>

    <script>
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('knob');
        const speedControl = document.getElementById('speed');
        let isDragging = false;

        joystick.addEventListener('mousedown', function(e) {
            isDragging = true;
        });

        document.addEventListener('mouseup', function(e) {
            isDragging = false;
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const deltaX = e.clientX - centerX;
                const deltaY = e.clientY - centerY;
                const distance = Math.min(75, Math.sqrt(deltaX * deltaX + deltaY * deltaY));
                const angle = Math.atan2(deltaY, deltaX);

                const knobX = 75 + distance * Math.cos(angle);
                const knobY = 75 + distance * Math.sin(angle);
                knob.style.left = `${knobX}px`;
                knob.style.top = `${knobY}px`;

                const speedMultiplier = speedControl.value / 100;

                let motorASpeed = distance * speedMultiplier;
                let motorBSpeed = distance * speedMultiplier;

                if (deltaY < 0) {  // Forward
                    motorASpeed = motorASpeed;
                    motorBSpeed = motorBSpeed;
                } else {  // Backward
                    motorASpeed = -motorASpeed;
                    motorBSpeed = -motorBSpeed;
                }

                if (deltaX > 0) {  // Right
                    motorASpeed = motorASpeed * (1 - Math.abs(deltaX / 75));
                    motorBSpeed = motorBSpeed * (1 + Math.abs(deltaX / 75));
                } else {  // Left
                    motorASpeed = motorASpeed * (1 + Math.abs(deltaX / 75));
                    motorBSpeed = motorBSpeed * (1 - Math.abs(deltaX / 75));
                }

                controlMotors(motorASpeed, motorBSpeed);
            }
        });

        function controlMotors(motorA, motorB) {
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `motorA=${motorA}&motorB=${motorB}`
            });
        }
    </script>
</body>
</html>